<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-Force Security - Unified Command Center</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#000000"/>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111111;
            --primary-red: #dc2626;
            --text-color: #ffffff;
            --text-muted: #9ca3af;
            --border-color: #333333;
            --success-color: #22c55e;
        }
        
        body, html { margin: 0; padding: 0; height: 100%; box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Rajdhani', sans-serif; overflow: hidden; }
        
        /* --- Login Screen --- */
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--bg-color); width: 100%; }
        .login-box { background-color: var(--card-bg); padding: 40px; border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8); width: 90%; max-width: 400px; text-align: center; }
        .login-box h2 { color: var(--primary-red); margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 15px; background: #000; border: 1px solid var(--border-color); color: white; border-radius: 2px; box-sizing: border-box; font-size: 16px; }
        .save-btn { padding: 14px 20px; background-color: var(--primary-red); color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 700; text-transform: uppercase; width: 100%; }
        
        /* --- App Shell --- */
        .app-container { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        header { text-align: center; padding: 15px; background: rgba(0,0,0,0.95); border-bottom: 2px solid var(--primary-red); flex-shrink: 0; }
        header h1 { margin: 0; font-size: 1.8em; font-weight: 700; text-transform: uppercase; }
        .title-red { color: var(--primary-red); }
        
        .sign-out-btn { position: absolute; top: 20px; right: 20px; background: none; border: 1px solid var(--border-color); color: var(--text-muted); padding: 5px 10px; cursor: pointer; color: white; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; font-weight: bold; }
        
        nav { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .nav-btn { padding: 10px 20px; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; font-weight: 600; text-transform: uppercase; }
        .nav-btn.active { background: var(--primary-red); color: white; border-color: var(--primary-red); }
        
        main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        
        /* --- Live Feed --- */
        .live-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .live-card { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--success-color); padding: 20px; border-radius: 4px; }
        .live-card h3 { margin: 0 0 10px 0; color: white; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .live-card p { margin: 5px 0; color: var(--text-muted); }
        .status { color: var(--success-color); font-weight: bold; }
        .coords { display: block; background: #000; padding: 8px; margin-top: 10px; color: var(--primary-red); font-family: monospace; border: 1px solid var(--border-color); }
        
        /* --- Logs --- */
        .logs-controls { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .print-btn { background: #333; color: white; border: 1px solid var(--border-color); padding: 10px 20px; cursor: pointer; font-weight: bold; font-family: 'Rajdhani', sans-serif; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; background: #1a1a1a; color: var(--text-muted); border-bottom: 2px solid var(--primary-red); }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); color: white; }
    </style>
</head>
<body>

    <!-- SINGLE ROOT FOR REACT -->
    <div id="root"></div>

    <!-- 1. BRIDGE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, orderBy, limit, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwhzGsK-ah7ObMOgpRDlzGghycLNinm6g",
            authDomain: "tforce-guardian-system.firebaseapp.com",
            projectId: "tforce-guardian-system",
            storageBucket: "tforce-guardian-system.firebasestorage.app",
            messagingSenderId: "194168927826",
            appId: "1:194168927826:web:18073e1a188b8e4408118b"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fbAuth = getAuth(app);
            window.fbDb = getFirestore(app);
            window.fbFuncs = { onAuthStateChanged, signInWithEmailAndPassword, signOut, collection, onSnapshot, orderBy, limit, doc, setDoc };
            // Signal Ready
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <!-- 2. REACT DEP -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. APP LOGIC -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // SAFE DATE FORMATTER
        const fmtDate = (ts) => {
            if(!ts || !ts.toDate) return "PENDING...";
            try { return ts.toDate().toLocaleTimeString(); } catch(e) { return "ERR"; }
        };

        // LOGIN COMPONENT
        const Login = () => {
            const [email, setEmail] = useState("");
            const [pass, setPass] = useState("");
            
            const handleLogin = (e) => {
                e.preventDefault();
                window.fbFuncs.signInWithEmailAndPassword(window.fbAuth, email, pass).catch(err => alert(err.message));
            };

            return (
                <div className="login-container">
                    <div className="login-box">
                        <h2>SECURE LOGIN</h2>
                        <form onSubmit={handleLogin}>
                            <input className="login-input" type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input className="login-input" type="password" placeholder="Password" value={pass} onChange={e=>setPass(e.target.value)} required />
                            <button type="submit" className="save-btn">AUTHENTICATE</button>
                        </form>
                    </div>
                </div>
            );
        };

        // DASHBOARD COMPONENT
        const Dashboard = ({ user }) => {
            const [view, setView] = useState('live');
            const [units, setUnits] = useState([]);
            const [logs, setLogs] = useState([]);

            // Live Feed Listener
            useEffect(() => {
                if(view !== 'live') return;
                const { collection, onSnapshot } = window.fbFuncs;
                const unsub = onSnapshot(collection(window.fbDb, 'locations'), snap => {
                    const data = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    const now = new Date();
                    const active = data.filter(u => {
                        if(!u.timestamp || !u.timestamp.toDate) return false;
                        const diff = (now - u.timestamp.toDate()) / 1000 / 60;
                        return u.onDuty && diff < 60;
                    });
                    setUnits(active);
                });
                return () => unsub();
            }, [view]);

            // Logs Listener
            useEffect(() => {
                if(view !== 'logs') return;
                const { collection, onSnapshot } = window.fbFuncs;
                // Simplified query to avoid index errors initially
                const unsub = onSnapshot(collection(window.fbDb, 'scan_logs'), snap => {
                    let data = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    // Manual Sort
                    data.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setLogs(data.slice(0, 50));
                });
                return () => unsub();
            }, [view]);

            return (
                <div className="app-container">
                    <header>
                        <h1><span className="title-red">T-FORCE</span> <span style={{color:'white'}}>COMMAND</span></h1>
                        <nav>
                            <button className={`nav-btn ${view==='live'?'active':''}`} onClick={()=>setView('live')}>ACTIVE UNITS</button>
                            <button className={`nav-btn ${view==='logs'?'active':''}`} onClick={()=>setView('logs')}>SCAN LOGS</button>
                        </nav>
                        <button className="sign-out-btn" onClick={() => window.fbFuncs.signOut(window.fbAuth)}>SIGN OUT</button>
                    </header>

                    <main>
                        {view === 'live' && (
                            <div className="live-grid">
                                {units.length === 0 && <p style={{color:'#666', textAlign:'center', gridColumn:'1/-1', marginTop:'50px', fontSize:'20px'}}>NO ACTIVE UNITS</p>}
                                {units.map(u => (
                                    <div key={u.id} className="live-card">
                                        <h3>{u.username}</h3>
                                        <p className="status">‚óè ON DUTY</p>
                                        <p>Last Signal: {fmtDate(u.timestamp)}</p>
                                        <code className="coords">{u.latitude?.toFixed(5)}, {u.longitude?.toFixed(5)}</code>
                                        <a href={`https://www.google.com/maps?q=${u.latitude},${u.longitude}`} target="_blank" style={{color:'#dc2626', display:'block', marginTop:'10px', textAlign:'right', textDecoration:'none', fontWeight:'bold'}}>OPEN MAP &rarr;</a>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'logs' && (
                            <div>
                                <div className="logs-controls">
                                    <h3 style={{color:'#dc2626', margin:0}}>CHECKPOINT LOGS</h3>
                                    <button className="print-btn" onClick={()=>window.print()}>PRINT REPORT</button>
                                </div>
                                <div style={{overflowX:'auto', border:'1px solid #333'}}>
                                    <table>
                                        <thead><tr><th>TIME</th><th>OFFICER</th><th>LOCATION</th></tr></thead>
                                        <tbody>
                                            {logs.map(l => (
                                                <tr key={l.id}>
                                                    <td style={{fontFamily:'monospace', color:'#9ca3af'}}>{fmtDate(l.timestamp)}</td>
                                                    <td style={{fontWeight:'bold'}}>{l.username}</td>
                                                    <td>{l.checkpointData}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // ROOT CONTROLLER
        const Main = () => {
            const [user, setUser] = useState(null);
            const [ready, setReady] = useState(false);

            useEffect(() => {
                const init = () => {
                    if(window.fbFuncs && window.fbAuth) {
                        window.fbFuncs.onAuthStateChanged(window.fbAuth, (u) => {
                            setUser(u);
                            setReady(true);
                        });
                    }
                };
                
                // If firebase loads faster than react
                if(window.fbAuth) init();
                // If react loads faster than firebase
                window.addEventListener('firebase-ready', init);
                
                return () => window.removeEventListener('firebase-ready', init);
            }, []);

            if(!ready) return <div style={{color:'#dc2626', display:'flex', justifyContent:'center', alignItems:'center', height:'100vh', fontSize:'24px', letterSpacing:'2px'}}>INITIALIZING SYSTEM...</div>;
            
            return user ? <Dashboard user={user} /> : <Login />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Main />);
    </script>
</body>
</html>
